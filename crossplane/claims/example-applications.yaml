# -----------------------------------------------------------------------------
# Example: Deploy Application to Customer Enclave
#
# This creates:
# 1. Kubernetes Deployment in the target enclave's workloads namespace
# 2. Kubernetes Service exposing the app
# 3. TeleportApp CR registering the app with Teleport for secure access
#
# Authorization is handled by Cedar policies via OPAL based on:
# - User attributes (clearanceLevel, cuiAuthorized, groups) from Teleport
# - Resource attributes (cuiWorkload flag sets cuiEnclave=true)
# -----------------------------------------------------------------------------
apiVersion: usenabla.com/v1alpha1
kind: ApplicationClaim
metadata:
  name: acme-dashboard
  namespace: customers
spec:
  targetEnclave: acme-corp

  name: company-dashboard
  image: ghcr.io/acme-corp/dashboard:v2.1.0
  replicas: 2
  port: 3000

  resources:
    cpu: "500m"
    memory: "512Mi"

  environment:
    - name: COMPANY_NAME
      value: "Acme Corp"

  # Teleport App Access - makes app available at dashboard.enclave.acme-corp.com
  teleportApp:
    enabled: true
    subdomain: dashboard

---
# -----------------------------------------------------------------------------
# Example: CUI Application for Defense Customer
#
# Setting cuiWorkload: true:
# 1. Deploys to workloads-cui namespace (runs on FIPS nodes)
# 2. Network policy restricts egress to CUI data tier only
# 3. Cedar policies enforce:
#    - principal.cuiAuthorized must be true
#    - principal.mfaVerified must be true
#    - principal.clearanceLevel must be "confidential" or higher
#    - Export actions are forbidden
# -----------------------------------------------------------------------------
apiVersion: usenabla.com/v1alpha1
kind: ApplicationClaim
metadata:
  name: bigcorp-classified-app
  namespace: customers
spec:
  targetEnclave: bigcorp-defense

  name: classified-viewer
  image: ghcr.io/bigcorp-defense/cui-viewer:v1.0.0
  replicas: 1
  port: 8443
  cuiWorkload: true  # CUI isolation + Cedar policy enforcement

  resources:
    cpu: "1"
    memory: "1Gi"

  storage:
    enabled: true
    size: 20Gi
    mountPath: /secure-data

  teleportApp:
    enabled: true
    subdomain: classified
    # App is available at classified.enclave.bigcorp.mil
    # Access controlled by Cedar policies for CUI

---
# -----------------------------------------------------------------------------
# Example: Internal Tool (No Teleport App Access)
# For apps that only need internal cluster access, not external
# -----------------------------------------------------------------------------
apiVersion: usenabla.com/v1alpha1
kind: ApplicationClaim
metadata:
  name: acme-worker
  namespace: customers
spec:
  targetEnclave: acme-corp

  name: background-worker
  image: ghcr.io/acme-corp/worker:v1.0.0
  replicas: 3
  port: 9090

  resources:
    cpu: "250m"
    memory: "256Mi"

  # No Teleport app - internal only
  teleportApp:
    enabled: false

---
# -----------------------------------------------------------------------------
# Example: Status Page (Public via Teleport)
# -----------------------------------------------------------------------------
apiVersion: usenabla.com/v1alpha1
kind: ApplicationClaim
metadata:
  name: startup-status-page
  namespace: customers
spec:
  targetEnclave: startup-xyz

  name: status-page
  image: ghcr.io/startup-xyz/status:v1.5.0
  replicas: 1
  port: 3000

  resources:
    cpu: "100m"
    memory: "128Mi"

  teleportApp:
    enabled: true
    subdomain: status
    # Teleport handles auth; Cedar policy "readonly-public-access" allows
    # users in Nabla::Group::"ReadOnly" to access public/internal resources
