# -----------------------------------------------------------------------------
# EnclaveApplication XRD - Deploys apps to customer enclaves via Teleport
# Creates Kubernetes Deployment + Service + TeleportApp CR
# -----------------------------------------------------------------------------
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: enclaveapplications.usenabla.com
spec:
  group: usenabla.com
  names:
    kind: EnclaveApplication
    plural: enclaveapplications
    shortNames:
      - eapp
  claimNames:
    kind: ApplicationClaim
    plural: applicationclaims
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - name
                - image
                - targetEnclave
              properties:
                # Target enclave for deployment
                targetEnclave:
                  type: string
                  description: "Name of the EnclaveInstance to deploy to"

                # Application configuration
                name:
                  type: string
                  description: "Application name"
                  pattern: "^[a-z][a-z0-9-]*$"
                image:
                  type: string
                  description: "Container image"
                replicas:
                  type: integer
                  minimum: 1
                  maximum: 10
                  default: 1
                port:
                  type: integer
                  default: 8080
                resources:
                  type: object
                  properties:
                    cpu:
                      type: string
                      default: "500m"
                    memory:
                      type: string
                      default: "512Mi"
                environment:
                  type: array
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                      value:
                        type: string
                storage:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      default: false
                    size:
                      type: string
                      default: "10Gi"
                    mountPath:
                      type: string
                      default: "/data"

                # Teleport App Access configuration
                teleportApp:
                  type: object
                  properties:
                    enabled:
                      type: boolean
                      description: "Register as Teleport Application for secure access"
                      default: true
                    subdomain:
                      type: string
                      description: "Subdomain for app access (e.g., 'dashboard' -> dashboard.enclave.customer.com)"
                    publicAddr:
                      type: string
                      description: "Override full public address (optional)"
                    insecureSkipVerify:
                      type: boolean
                      description: "Skip TLS verification for backend (internal apps)"
                      default: true

                # CUI workload flag
                cuiWorkload:
                  type: boolean
                  description: "Deploy to CUI-isolated namespace (FIPS nodes, isolated network)"
                  default: false

            status:
              type: object
              properties:
                phase:
                  type: string
                  enum:
                    - Pending
                    - Deploying
                    - Running
                    - Failed
                targetCluster:
                  type: string
                  description: "Enclave cluster where app is deployed"
                namespace:
                  type: string
                  description: "Kubernetes namespace"
                teleportAppUrl:
                  type: string
                  description: "Teleport Application access URL"
                message:
                  type: string

      additionalPrinterColumns:
        - name: Enclave
          type: string
          jsonPath: .spec.targetEnclave
        - name: Image
          type: string
          jsonPath: .spec.image
        - name: CUI
          type: boolean
          jsonPath: .spec.cuiWorkload
        - name: Phase
          type: string
          jsonPath: .status.phase
        - name: URL
          type: string
          jsonPath: .status.teleportAppUrl
        - name: Age
          type: date
          jsonPath: .metadata.creationTimestamp

---
# -----------------------------------------------------------------------------
# EnclaveApplication Composition
# Creates: Deployment + Service + TeleportApp CR in target enclave
# -----------------------------------------------------------------------------
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: enclave-application
  labels:
    crossplane.io/xrd: enclaveapplications.usenabla.com
spec:
  compositeTypeRef:
    apiVersion: usenabla.com/v1alpha1
    kind: EnclaveApplication

  resources:
    # -------------------------------------------------------------------------
    # Kubernetes Deployment
    # -------------------------------------------------------------------------
    - name: deployment
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          providerConfigRef:
            name: ""  # Patched to target enclave
          forProvider:
            manifest:
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                namespace: workloads
              spec:
                replicas: 1
                selector:
                  matchLabels: {}
                template:
                  metadata:
                    labels: {}
                  spec:
                    securityContext:
                      runAsNonRoot: true
                      seccompProfile:
                        type: RuntimeDefault
                    containers:
                      - name: app
                        securityContext:
                          allowPrivilegeEscalation: false
                          capabilities:
                            drop:
                              - ALL
                          readOnlyRootFilesystem: true
                        resources:
                          requests:
                            cpu: "500m"
                            memory: "512Mi"
                          limits:
                            cpu: "1"
                            memory: "1Gi"
      patches:
        # Provider config references enclave's kubeconfig
        - type: FromCompositeFieldPath
          fromFieldPath: spec.targetEnclave
          toFieldPath: spec.providerConfigRef.name
          transforms:
            - type: string
              string:
                fmt: "enclave-%s"

        # Deployment name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.name
          toFieldPath: spec.forProvider.manifest.metadata.name

        # Choose namespace based on CUI flag
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cuiWorkload
          toFieldPath: spec.forProvider.manifest.metadata.namespace
          transforms:
            - type: map
              map:
                "true": workloads-cui
                "false": workloads

        # Labels
        - type: FromCompositeFieldPath
          fromFieldPath: spec.name
          toFieldPath: spec.forProvider.manifest.spec.selector.matchLabels["app.kubernetes.io/name"]

        - type: FromCompositeFieldPath
          fromFieldPath: spec.name
          toFieldPath: spec.forProvider.manifest.spec.template.metadata.labels["app.kubernetes.io/name"]

        # Replicas
        - type: FromCompositeFieldPath
          fromFieldPath: spec.replicas
          toFieldPath: spec.forProvider.manifest.spec.replicas

        # Container image
        - type: FromCompositeFieldPath
          fromFieldPath: spec.image
          toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].image

        # Container port
        - type: FromCompositeFieldPath
          fromFieldPath: spec.port
          toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].ports[0].containerPort

    # -------------------------------------------------------------------------
    # Kubernetes Service
    # -------------------------------------------------------------------------
    - name: service
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          providerConfigRef:
            name: ""
          forProvider:
            manifest:
              apiVersion: v1
              kind: Service
              metadata:
                namespace: workloads
              spec:
                type: ClusterIP
                ports:
                  - port: 80
                    targetPort: 8080
                    protocol: TCP
                selector: {}
      patches:
        # Provider config
        - type: FromCompositeFieldPath
          fromFieldPath: spec.targetEnclave
          toFieldPath: spec.providerConfigRef.name
          transforms:
            - type: string
              string:
                fmt: "enclave-%s"

        # Service name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.name
          toFieldPath: spec.forProvider.manifest.metadata.name

        # Namespace
        - type: FromCompositeFieldPath
          fromFieldPath: spec.cuiWorkload
          toFieldPath: spec.forProvider.manifest.metadata.namespace
          transforms:
            - type: map
              map:
                "true": workloads-cui
                "false": workloads

        # Target port
        - type: FromCompositeFieldPath
          fromFieldPath: spec.port
          toFieldPath: spec.forProvider.manifest.spec.ports[0].targetPort

        # Selector
        - type: FromCompositeFieldPath
          fromFieldPath: spec.name
          toFieldPath: spec.forProvider.manifest.spec.selector["app.kubernetes.io/name"]

    # -------------------------------------------------------------------------
    # TeleportApp CR - Registers app with Teleport for secure access
    # -------------------------------------------------------------------------
    - name: teleport-app
      base:
        apiVersion: kubernetes.crossplane.io/v1alpha2
        kind: Object
        spec:
          providerConfigRef:
            name: ""
          forProvider:
            manifest:
              apiVersion: resources.teleport.dev/v1
              kind: TeleportApp
              metadata:
                namespace: teleport
              spec:
                uri: ""
                insecure_skip_verify: true
      patches:
        # Provider config
        - type: FromCompositeFieldPath
          fromFieldPath: spec.targetEnclave
          toFieldPath: spec.providerConfigRef.name
          transforms:
            - type: string
              string:
                fmt: "enclave-%s"

        # App name
        - type: FromCompositeFieldPath
          fromFieldPath: spec.name
          toFieldPath: spec.forProvider.manifest.metadata.name

        # URI - internal service address
        - type: CombineFromComposite
          combine:
            variables:
              - fromFieldPath: spec.name
              - fromFieldPath: spec.cuiWorkload
              - fromFieldPath: spec.port
            strategy: string
            string:
              fmt: "http://%s.%s.svc.cluster.local:%d"
          toFieldPath: spec.forProvider.manifest.spec.uri
          transforms:
            - type: string
              string:
                fmt: "http://%s.workloads.svc.cluster.local:%s"

        # Public address (subdomain.enclave.domain)
        - type: FromCompositeFieldPath
          fromFieldPath: spec.teleportApp.subdomain
          toFieldPath: spec.forProvider.manifest.spec.public_addr

        # Skip TLS verification for internal services
        - type: FromCompositeFieldPath
          fromFieldPath: spec.teleportApp.insecureSkipVerify
          toFieldPath: spec.forProvider.manifest.spec.insecure_skip_verify

        # Status: Teleport app URL
        - type: ToCompositeFieldPath
          fromFieldPath: spec.forProvider.manifest.spec.public_addr
          toFieldPath: status.teleportAppUrl
