# =============================================================================
# OPAL Server Configuration
# Policy Administration Layer for Nabla Enclave
# =============================================================================

# Server settings
server:
  host: "0.0.0.0"
  port: 7002

# Policy repository configuration
policy_repo:
  # Git repository URL (set via environment variable OPAL_POLICY_REPO_URL)
  url: "${OPAL_POLICY_REPO_URL}"
  branch: "${OPAL_POLICY_REPO_MAIN_BRANCH:-main}"

  # Paths within the repo to watch for policy changes
  policy_paths:
    - "cedar/policies"
    - "cedar/schema"

  # Polling interval for policy updates (seconds)
  polling_interval: 30

  # SSH key for private repos (set via environment variable)
  ssh_key: "${OPAL_POLICY_REPO_SSH_KEY}"

# Policy bundle configuration
policy_bundle:
  # Cedar-specific settings
  cedar:
    schema_path: "cedar/schema"
    policies_path: "cedar/policies"
    entities_path: "cedar/entities"

# Data sources configuration
data_sources:
  # Entity data from Kubernetes
  kubernetes:
    enabled: true
    namespaces:
      - workloads
      - teleport
      - policy-system
      - observability
      - data
      - secrets

  # Entity data from Teleport
  teleport:
    enabled: true
    url: "${TELEPORT_AUTH_URL}"
    # Sync users, roles, and sessions
    sync_interval: 60

  # Entity data from PostgreSQL
  postgres:
    enabled: true
    connection_string: "${POSTGRES_CONNECTION_STRING}"
    sync_interval: 300

# Broadcasting configuration (for HA)
broadcast:
  # PostgreSQL backend for multi-replica coordination
  type: postgres
  connection_string: "${OPAL_BROADCAST_URI}"

# Logging configuration
logging:
  level: INFO
  format: json

# Health check endpoints
health:
  enabled: true
  path: /healthz

# Metrics (Prometheus)
metrics:
  enabled: true
  path: /metrics
  port: 7003

# Client authentication
auth:
  # JWT token validation for OPAL clients
  enabled: true
  jwt_audience: "opal-clients"
  jwt_issuer: "opal-server"
