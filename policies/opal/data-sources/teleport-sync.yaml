# =============================================================================
# Teleport Identity Data Source Configuration
# Syncs users, roles, and sessions from Teleport to OPAL/Cedar
# =============================================================================

# Data source configuration
source:
  name: teleport
  type: http
  description: "Teleport identity and access data"

# Teleport API configuration
connection:
  # Teleport auth service URL
  url: "${TELEPORT_AUTH_URL}"

  # Authentication (uses service account token)
  auth:
    type: bearer
    token_path: /var/run/secrets/teleport/token

  # TLS configuration
  tls:
    ca_cert_path: /var/run/secrets/teleport/ca.crt
    verify: true

# Data fetching configuration
fetch:
  # Fetch interval in seconds
  interval: 60

  # Endpoints to fetch
  endpoints:
    # Fetch all users
    - path: /v1/users
      transform: teleport_users_to_cedar
      topic: entity_data/users

    # Fetch all roles
    - path: /v1/roles
      transform: teleport_roles_to_cedar
      topic: entity_data/groups

    # Fetch active sessions
    - path: /v1/sessions
      transform: teleport_sessions_to_cedar
      topic: entity_data/sessions

# Data transformations
transformations:
  # Transform Teleport users to Cedar User entities
  # Includes CUI authorization and clearance level from Teleport traits
  teleport_users_to_cedar:
    type: jq
    expression: |
      .users | map({
        uid: {
          type: "Nabla::User",
          id: .metadata.name
        },
        attrs: {
          email: .spec.traits.email[0] // "",
          department: .spec.traits.department[0] // "default",
          # Clearance level from explicit trait, fallback to role-based
          clearanceLevel: (
            .spec.traits.clearance_level[0] // (
              if .spec.roles | contains(["cui-admin"]) then "restricted"
              elif .spec.roles | contains(["admin"]) then "restricted"
              elif .spec.roles | contains(["cui-developer"]) then "confidential"
              elif .spec.roles | contains(["developer"]) then "confidential"
              elif .spec.roles | contains(["auditor"]) then "internal"
              else "internal"
              end
            )
          ),
          mfaVerified: (.spec.traits.mfa_verified[0] // "false" | . == "true"),
          sessionId: "",
          # CUI authorization from Teleport trait
          cuiAuthorized: (.spec.traits.cui_authorized[0] // "false" | . == "true"),
          cuiTrainingDate: .spec.traits.cui_training_date[0] // ""
        },
        parents: [
          # Map roles to Cedar groups, including CUI groups
          .spec.roles | map({type: "Nabla::Group", id: (
            if . == "admin" then "Administrators"
            elif . == "cui-admin" then "CUIAdministrators"
            elif . == "developer" then "Developers"
            elif . == "cui-developer" then "CUIDevelopers"
            elif . == "auditor" then "Auditors"
            elif . == "cui-auditor" then "CUIAuditors"
            elif . == "cui-authorized" then "CUIAuthorized"
            else "ReadOnly"
            end
          )}),
          # Add CUIAuthorized group if trait is set
          if (.spec.traits.cui_authorized[0] // "false") == "true" then
            [{type: "Nabla::Group", id: "CUIAuthorized"}]
          else
            []
          end
        ] | flatten | unique
      })

  # Transform Teleport roles to Cedar Group entities
  # Includes CUI-specific roles and group hierarchies
  teleport_roles_to_cedar:
    type: jq
    expression: |
      .roles | map({
        uid: {
          type: "Nabla::Group",
          id: (
            if .metadata.name == "admin" then "Administrators"
            elif .metadata.name == "cui-admin" then "CUIAdministrators"
            elif .metadata.name == "developer" then "Developers"
            elif .metadata.name == "cui-developer" then "CUIDevelopers"
            elif .metadata.name == "auditor" then "Auditors"
            elif .metadata.name == "cui-auditor" then "CUIAuditors"
            elif .metadata.name == "cui-authorized" then "CUIAuthorized"
            elif .metadata.name == "access" then "ReadOnly"
            else .metadata.name
            end
          )
        },
        attrs: {
          description: .metadata.description // ""
        },
        # CUI roles inherit from base roles and CUIAuthorized
        parents: (
          if .metadata.name == "cui-admin" then
            [{type: "Nabla::Group", id: "Administrators"}, {type: "Nabla::Group", id: "CUIAuthorized"}]
          elif .metadata.name == "cui-developer" then
            [{type: "Nabla::Group", id: "Developers"}, {type: "Nabla::Group", id: "CUIAuthorized"}]
          elif .metadata.name == "cui-auditor" then
            [{type: "Nabla::Group", id: "Auditors"}, {type: "Nabla::Group", id: "CUIAuthorized"}]
          else
            []
          end
        )
      })

  # Transform active sessions to update user session IDs
  teleport_sessions_to_cedar:
    type: jq
    expression: |
      .sessions | map({
        user_id: .user,
        session_id: .id,
        mfa_verified: .mfa_verified
      })

# Error handling
error_handling:
  # Retry on failure
  retry:
    max_attempts: 3
    backoff_seconds: 5

  # Log errors but don't fail
  on_error: log

# Caching
cache:
  enabled: true
  ttl_seconds: 300
