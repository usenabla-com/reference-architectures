# =============================================================================
# Kubernetes Resource Data Source Configuration
# Syncs namespaces, pods, deployments, service accounts to OPAL/Cedar
# =============================================================================

# Data source configuration
source:
  name: kubernetes
  type: kubernetes
  description: "Kubernetes cluster resource data"

# Kubernetes API configuration
connection:
  # Use in-cluster configuration
  in_cluster: true

  # Or external kubeconfig
  # kubeconfig_path: /etc/opal/kubeconfig

# Namespaces to watch
namespaces:
  - workloads
  - teleport
  - policy-system
  - observability
  - data
  - secrets
  - kube-system

# Resources to sync
resources:
  # Sync namespaces
  - kind: Namespace
    api_version: v1
    transform: namespace_to_cedar
    topic: entity_data/namespaces

  # Sync service accounts
  - kind: ServiceAccount
    api_version: v1
    transform: serviceaccount_to_cedar
    topic: entity_data/service_accounts

  # Sync pods (for workload entities)
  - kind: Pod
    api_version: v1
    transform: pod_to_cedar
    topic: entity_data/pods

  # Sync deployments
  - kind: Deployment
    api_version: apps/v1
    transform: deployment_to_cedar
    topic: entity_data/deployments

  # Sync secrets (metadata only, not values)
  - kind: Secret
    api_version: v1
    transform: secret_to_cedar
    topic: entity_data/secrets

  # Sync configmaps
  - kind: ConfigMap
    api_version: v1
    transform: configmap_to_cedar
    topic: entity_data/configmaps

# Data transformations
transformations:
  # Transform K8s Namespace to Cedar Namespace entity
  namespace_to_cedar:
    type: jq
    expression: |
      {
        uid: {
          type: "Nabla::Namespace",
          id: .metadata.name
        },
        attrs: {
          name: .metadata.name,
          environment: (.metadata.labels["environment"] // "production"),
          securityTier: (
            if .metadata.name == "kube-system" or .metadata.name == "teleport" or .metadata.name == "policy-system" or .metadata.name == "secrets" then "system"
            elif .metadata.name == "data" then "data"
            else "workload"
            end
          )
        },
        parents: []
      }

  # Transform K8s ServiceAccount to Cedar ServiceAccount entity
  serviceaccount_to_cedar:
    type: jq
    expression: |
      {
        uid: {
          type: "Nabla::ServiceAccount",
          id: "\(.metadata.namespace)/\(.metadata.name)"
        },
        attrs: {
          namespace: .metadata.namespace,
          workload: (.metadata.labels["app.kubernetes.io/name"] // .metadata.name)
        },
        parents: [
          {
            type: "Nabla::Group",
            id: (
              if .metadata.namespace == "workloads" then "WorkloadServiceAccounts"
              elif .metadata.namespace == "data" then "DataServiceAccounts"
              else "ServiceAccounts"
              end
            )
          }
        ]
      }

  # Transform K8s Pod to Cedar Pod entity
  pod_to_cedar:
    type: jq
    expression: |
      {
        uid: {
          type: "Nabla::Pod",
          id: "\(.metadata.namespace)/\(.metadata.name)"
        },
        attrs: {
          name: .metadata.name,
          serviceAccount: .spec.serviceAccountName,
          labels: ([.metadata.labels | to_entries[] | .key + "=" + .value] // [])
        },
        parents: [
          {
            type: "Nabla::Namespace",
            id: .metadata.namespace
          }
        ]
      }

  # Transform K8s Deployment to Cedar Deployment entity
  deployment_to_cedar:
    type: jq
    expression: |
      {
        uid: {
          type: "Nabla::Deployment",
          id: "\(.metadata.namespace)/\(.metadata.name)"
        },
        attrs: {
          name: .metadata.name,
          replicas: (.spec.replicas // 1)
        },
        parents: [
          {
            type: "Nabla::Namespace",
            id: .metadata.namespace
          }
        ]
      }

  # Transform K8s Secret to Cedar Secret entity (metadata only)
  secret_to_cedar:
    type: jq
    expression: |
      {
        uid: {
          type: "Nabla::Secret",
          id: "\(.metadata.namespace)/\(.metadata.name)"
        },
        attrs: {
          name: .metadata.name,
          type: .type
        },
        parents: [
          {
            type: "Nabla::Namespace",
            id: .metadata.namespace
          }
        ]
      }

  # Transform K8s ConfigMap to Cedar ConfigMap entity
  configmap_to_cedar:
    type: jq
    expression: |
      {
        uid: {
          type: "Nabla::ConfigMap",
          id: "\(.metadata.namespace)/\(.metadata.name)"
        },
        attrs: {
          name: .metadata.name
        },
        parents: [
          {
            type: "Nabla::Namespace",
            id: .metadata.namespace
          }
        ]
      }

# Watch configuration
watch:
  enabled: true
  # Resync interval (full sync even with watch)
  resync_interval_seconds: 300

# Error handling
error_handling:
  retry:
    max_attempts: 3
    backoff_seconds: 5
  on_error: log

# Caching
cache:
  enabled: true
  ttl_seconds: 60
