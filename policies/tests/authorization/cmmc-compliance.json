{
  "description": "CMMC compliance policy tests",
  "tests": [
    {
      "name": "CMMC AC.L2-3.1.3: User without clearance denied CUI access",
      "principal": {
        "type": "Nabla::User",
        "id": "public-user@nabla.io"
      },
      "action": {
        "type": "Nabla::Action",
        "id": "read"
      },
      "resource": {
        "type": "Nabla::DatabaseTable",
        "id": "mattermost.posts"
      },
      "context": {},
      "entities": [
        {
          "uid": { "type": "Nabla::User", "id": "public-user@nabla.io" },
          "attrs": {
            "email": "public-user@nabla.io",
            "department": "external",
            "clearanceLevel": "public",
            "mfaVerified": true,
            "sessionId": "session-ext-123"
          },
          "parents": [
            { "type": "Nabla::Group", "id": "ReadOnly" }
          ]
        },
        {
          "uid": { "type": "Nabla::DatabaseTable", "id": "mattermost.posts" },
          "attrs": {
            "name": "posts",
            "containsPII": false,
            "containsCUI": true
          },
          "parents": []
        }
      ],
      "expected": "deny"
    },
    {
      "name": "CMMC IA.L2-3.5.3: MFA required for CUI database access",
      "principal": {
        "type": "Nabla::User",
        "id": "dev-nomfa@nabla.io"
      },
      "action": {
        "type": "Nabla::Action",
        "id": "read"
      },
      "resource": {
        "type": "Nabla::DatabaseTable",
        "id": "nextcloud.files"
      },
      "context": {},
      "entities": [
        {
          "uid": { "type": "Nabla::User", "id": "dev-nomfa@nabla.io" },
          "attrs": {
            "email": "dev-nomfa@nabla.io",
            "department": "engineering",
            "clearanceLevel": "confidential",
            "mfaVerified": false,
            "sessionId": "session-nomfa-123"
          },
          "parents": [
            { "type": "Nabla::Group", "id": "Developers" }
          ]
        },
        {
          "uid": { "type": "Nabla::DatabaseTable", "id": "nextcloud.files" },
          "attrs": {
            "name": "files",
            "containsPII": false,
            "containsCUI": true
          },
          "parents": []
        }
      ],
      "expected": "deny"
    },
    {
      "name": "CMMC AU.L2-3.3.8: Non-auditor denied audit log access",
      "principal": {
        "type": "Nabla::User",
        "id": "dev@nabla.io"
      },
      "action": {
        "type": "Nabla::Action",
        "id": "read"
      },
      "resource": {
        "type": "Nabla::AuditLog",
        "id": "system-audit"
      },
      "context": {},
      "entities": [
        {
          "uid": { "type": "Nabla::User", "id": "dev@nabla.io" },
          "attrs": {
            "email": "dev@nabla.io",
            "department": "engineering",
            "clearanceLevel": "confidential",
            "mfaVerified": true,
            "sessionId": "session-dev-123"
          },
          "parents": [
            { "type": "Nabla::Group", "id": "Developers" }
          ]
        }
      ],
      "expected": "deny"
    },
    {
      "name": "CMMC AU.L2-3.3.8: Auditor can read audit logs",
      "principal": {
        "type": "Nabla::User",
        "id": "auditor@nabla.io"
      },
      "action": {
        "type": "Nabla::Action",
        "id": "read"
      },
      "resource": {
        "type": "Nabla::AuditLog",
        "id": "system-audit"
      },
      "context": {},
      "entities": [
        {
          "uid": { "type": "Nabla::User", "id": "auditor@nabla.io" },
          "attrs": {
            "email": "auditor@nabla.io",
            "department": "compliance",
            "clearanceLevel": "internal",
            "mfaVerified": true,
            "sessionId": "session-aud-123"
          },
          "parents": [
            { "type": "Nabla::Group", "id": "Auditors" }
          ]
        }
      ],
      "expected": "allow"
    },
    {
      "name": "CMMC AU.L2-3.3.8: Audit logs cannot be deleted",
      "principal": {
        "type": "Nabla::User",
        "id": "admin@nabla.io"
      },
      "action": {
        "type": "Nabla::Action",
        "id": "delete"
      },
      "resource": {
        "type": "Nabla::AuditLog",
        "id": "system-audit"
      },
      "context": {},
      "entities": [
        {
          "uid": { "type": "Nabla::User", "id": "admin@nabla.io" },
          "attrs": {
            "email": "admin@nabla.io",
            "department": "engineering",
            "clearanceLevel": "restricted",
            "mfaVerified": true,
            "sessionId": "session-123"
          },
          "parents": [
            { "type": "Nabla::Group", "id": "Administrators" }
          ]
        }
      ],
      "expected": "deny"
    },
    {
      "name": "CMMC MP.L2-3.8.7: Export requires MFA",
      "principal": {
        "type": "Nabla::User",
        "id": "dev-nomfa@nabla.io"
      },
      "action": {
        "type": "Nabla::Action",
        "id": "export"
      },
      "resource": {
        "type": "Nabla::StorageBucket",
        "id": "minio-nextcloud"
      },
      "context": {},
      "entities": [
        {
          "uid": { "type": "Nabla::User", "id": "dev-nomfa@nabla.io" },
          "attrs": {
            "email": "dev-nomfa@nabla.io",
            "department": "engineering",
            "clearanceLevel": "confidential",
            "mfaVerified": false,
            "sessionId": "session-123"
          },
          "parents": [
            { "type": "Nabla::Group", "id": "Developers" }
          ]
        }
      ],
      "expected": "deny"
    }
  ]
}
