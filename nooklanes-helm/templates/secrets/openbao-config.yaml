{{- if .Values.secrets.enabled }}
# =============================================================================
# OpenBao Configuration ConfigMap
# Configures Raft storage and auto-unseal
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: openbao-config
  namespace: openbao
  labels:
    app.kubernetes.io/name: openbao
    app.kubernetes.io/component: secrets
data:
  openbao.hcl: |
    ui = true

    listener "tcp" {
      tls_disable = 1
      address     = "[::]:8200"
      cluster_address = "[::]:8201"
    }

    storage "raft" {
      path = "/openbao/data"
      node_id = "${POD_NAME}"

      {{- range $i := until (int .Values.secrets.openbao.replicas) }}
      retry_join {
        leader_api_addr = "http://openbao-{{ $i }}.openbao-internal.openbao.svc.cluster.local:8200"
      }
      {{- end }}
    }

    service_registration "kubernetes" {}

    {{- if ne .Values.secrets.openbao.seal.type "shamir" }}
    {{ include "nooklanes.openbao.sealConfig" .Values.secrets.openbao | nindent 4 }}
    {{- end }}

    {{- if .Values.secrets.openbao.audit.enabled }}
    # Audit logging will be enabled after initialization
    {{- end }}

    api_addr = "http://${POD_IP}:8200"
    cluster_addr = "http://${POD_IP}:8201"
{{- end }}
