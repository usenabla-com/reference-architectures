{{- if and .Values.secrets.openbaoCui.enabled .Values.swimlanes.cuiEnabled }}
# =============================================================================
# OpenBao-CUI Configuration ConfigMap
# Enhanced security configuration for CUI secrets management
# =============================================================================
apiVersion: v1
kind: ConfigMap
metadata:
  name: openbao-cui-config
  namespace: openbao-cui
  labels:
    app.kubernetes.io/name: openbao-cui
    app.kubernetes.io/component: secrets-cui
    nooklanes.io/cui-authorized: "true"
data:
  openbao.hcl: |
    ui = true

    listener "tcp" {
      tls_disable = 1
      address     = "[::]:8200"
      cluster_address = "[::]:8201"

      # Enhanced telemetry for CUI compliance
      telemetry {
        unauthenticated_metrics_access = false
      }
    }

    storage "raft" {
      path = "/openbao/data"
      node_id = "${POD_NAME}"

      {{- range $i := until (int .Values.secrets.openbaoCui.replicas) }}
      retry_join {
        leader_api_addr = "http://openbao-cui-{{ $i }}.openbao-cui-internal.openbao-cui.svc.cluster.local:8200"
      }
      {{- end }}
    }

    service_registration "kubernetes" {}

    {{- if ne .Values.secrets.openbaoCui.seal.type "shamir" }}
    {{ include "nooklanes.openbao.sealConfig" .Values.secrets.openbaoCui | nindent 4 }}
    {{- end }}

    # Enhanced audit logging for CUI (always enabled)
    # Audit device will be enabled after initialization

    # CUI-specific: Disable mlock (requires privileged) but ensure encrypted storage
    disable_mlock = true

    api_addr = "http://${POD_IP}:8200"
    cluster_addr = "http://${POD_IP}:8201"

    # CUI-specific: Enhanced log level
    log_level = "info"
    log_format = "json"
{{- end }}
