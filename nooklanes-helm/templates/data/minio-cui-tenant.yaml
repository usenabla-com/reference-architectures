{{- if and .Values.data.minioCui.enabled .Values.swimlanes.cuiEnabled }}
# =============================================================================
# MinIO Tenant - CUI Object Storage (Isolated & Encrypted)
# CMMC Level 2 compliant object storage for CUI data
# =============================================================================
apiVersion: v1
kind: Secret
metadata:
  name: minio-cui-credentials
  namespace: {{ .Values.swimlanes.cui.minioNamespace }}
  labels:
    nooklanes.io/cui-authorized: "true"
type: Opaque
stringData:
  accesskey: {{ randAlphaNum 20 }}
  secretkey: {{ randAlphaNum 40 }}

---
apiVersion: v1
kind: Secret
metadata:
  name: minio-postgres-cui-credentials
  namespace: {{ .Values.swimlanes.cui.postgresNamespace }}
  labels:
    nooklanes.io/cui-authorized: "true"
type: Opaque
stringData:
  accesskey: {{ randAlphaNum 20 }}
  secretkey: {{ randAlphaNum 40 }}

---
apiVersion: minio.min.io/v2
kind: Tenant
metadata:
  name: minio-cui
  namespace: {{ .Values.swimlanes.cui.minioNamespace }}
  labels:
    app.kubernetes.io/name: minio-cui
    app.kubernetes.io/component: object-storage-cui
    nooklanes.io/swimlane: "cui"
    nooklanes.io/data-classification: {{ .Values.swimlanes.cui.dataClassification }}
    nooklanes.io/cui-authorized: "true"
    nooklanes.io/encryption-required: "true"
spec:
  image: {{ .Values.global.chainguardRegistry }}/minio:latest

  pools:
    - servers: {{ .Values.data.minioCui.tenant.servers }}
      name: pool-0
      volumesPerServer: {{ .Values.data.minioCui.tenant.volumesPerServer }}
      volumeClaimTemplate:
        metadata:
          name: data
        spec:
          accessModes:
            - ReadWriteOnce
          resources:
            requests:
              storage: {{ .Values.data.minioCui.tenant.volumeSize }}
          {{- if or .Values.data.minioCui.tenant.storageClass .Values.global.storageClass }}
          storageClassName: {{ .Values.data.minioCui.tenant.storageClass | default .Values.global.storageClass }}
          {{- end }}
      resources:
        {{- toYaml .Values.data.minioCui.resources | nindent 8 }}
      securityContext:
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        runAsNonRoot: true

  mountPath: /data
  requestAutoCert: false

  # CUI-specific configuration
  env:
    - name: MINIO_SERVER_SIDE_ENCRYPTION_KMS_ENABLED
      value: "on"

  configuration:
    name: minio-cui-credentials

  users:
    - name: minio-postgres-cui-credentials

  buckets:
    {{- range .Values.data.minioCui.buckets }}
    - name: {{ .name }}
    {{- end }}

  features:
    enableSFTP: false
{{- end }}
